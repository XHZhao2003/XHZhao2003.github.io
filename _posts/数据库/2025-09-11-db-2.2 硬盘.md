---
layout: post
title:  "2.2 硬盘"
category: "数据库"
order: "2"
---

使用二级存储是数据库系统最重要的特点之一，而二级存储基本都是基于磁盘（magnetic disk）的。所以，为了阐明数据库系统实现的一些动机，我们先来考察磁盘操作的细节。

### 2.2.1 硬盘工作机制

磁盘驱动器的两个主要部件是磁盘组件（disk assembly）和磁头组件（head assembly）。磁盘组件包括一个或多个围绕中心主轴旋转的圆盘（platter）。盘的上下表面都覆盖有一层薄的磁性材料，数据位就存储在这些材料上。一个小区域的磁性方向朝向一个方向就表示0，朝向相反的方向就表示1。常见的盘片直径为 3.5 英寸。

数据位存储的位置被组织成磁道（tracks），也就是盘片表面上的一系列同心圆。刺刀占据了盘面的大部分区域，除了靠近主轴的区域。一条磁道上包含许多个点，每个点都通过磁性方向表示一个位。

磁道被划分为扇区（sectors），扇区是圆周上由未被磁化的间隙分隔开的片段。在读写磁盘时，扇区是一个不可分割的基本单位。发生错误时，扇区也是最小的单位。如果磁性表面的某一部分损坏了，从而无法存储信息，那么它所在的整个扇区都无法使用了。间隙通常占据了整个磁道的 10%，并可以用来标识扇区的开始。2.1.3 节提到的磁盘块（block），也就是在主存和磁盘之间传输数据的基本单位，通常包含一个或几个扇区。

另一个部件，磁头，是可以移动的。每个磁盘表面都拥有一个对应的磁头。磁头在距离盘面非常近的位置滑动，但是不会触碰盘面（如果触碰了，这块磁盘连带它存储的数据就被损毁了，这称为磁头碰撞）。磁头能够读取经过的盘面的数据，也可以向这些区域写入数据。每个磁头都连接在支架上，每个盘面对应的支架都是同步进出移动的。

### 2.2.2 磁盘控制器

磁盘控制器（disk controller）会控制着一个或多个磁盘驱动，具体包括以下几个方面：

1. 控制移动磁头的部件，来将磁头放置在一个特定的角度上，从而使磁头能读写到特定的磁道。同一时间下，所有磁头能够读写的所有磁道形成一个柱面（cylinder）

2. 选择一个要读写的盘面，并从磁道中选择一个扇区。控制器负责旋转主轴，直到目标磁道的开始处恰好被移动到磁头处。

3. 进行读写，也就是将目标扇区的数据加载到主存中，或者将主存中的数据写入到目标扇区中。


### 2.2.3 硬盘存储特点

硬盘技术是不断发展的，存储一个比特所需的空间在快速减少。到 1999 年，通行的指标如下

- 盘片组件的旋转速度。5400 RPM（即每11毫秒旋转一圈）是常见的，尽管也存在更高或更低的转速。

- 每个驱动器的盘片数量。典型的硬盘驱动器大约有五个盘片，因此共有十个盘面。然而，常见的软盘（“floppy”盘）和“zip”盘只有一个盘片，具有两个盘面；此外，也有最多可达30个盘面的硬盘驱动器。“单面软盘”（仅在一个盘片上有一个盘面）虽然已过时，但仍可能见到。

- 每个盘面的磁道数量。一个盘面最多可包含高达10,000条磁道。

- 每条磁道的字节数。常见的硬盘驱动器每条磁道有10⁵字节或更多，而软盘的磁道存储容量则较少。如前所述，磁道被划分为扇区，现代硬盘中每条磁道可能有多达500个扇区。每个扇区通常可存储约512到4096字节的数据。


举例：一个磁盘的容量 = 8 个盘面 $\times$ 8192 个磁道 $\times$ 256 个扇区 $\times$ 512 个字节 = $2^{33}$ 字节 = 8 GB。一个磁道能够容纳 128 KB。如果一个块大小是 4KB，那么它会横跨 8 个扇区，一个磁道上具有 32 个块。

一个疑问是，外圈的磁道与内圈的磁道包含的扇区数量如果是相同的，那就意味着它们存储字节的密度会相差若干倍。事实上，很多磁盘会在外圈磁道存储更多的扇区，内圈磁道存储更少的扇区。

### 2.2.4 磁盘访问特点

学习数据库管理系统不仅要求我们要理解数据是如何存储在磁盘上的，也需要理解数据是如何来操纵的。我们知道所有的数据运算都发生在主存或者缓存里，所以我们需要考虑如何将数据块从磁盘中移动到主存以及缓存里。2.2.2 节中提到过，要读写一个磁盘块，也就是读写连续的几个扇区时：

- 磁头要对准目标磁道所在的柱面
- 目标扇区的起始位置要旋转到对准磁头

这一过程的延迟称为磁盘延迟（latency），指的是从读一个块的命令发出，到这个块数据出现在主存中所经历的时间，具体可以分成以下几部分：

1. 处理器和磁盘控制器处理请求的时间，通常不到 1 毫秒。我们通常忽略这一时延。我们通常还会忽略磁盘控制器的排队时延，以及其他排队时延。
2. 磁头装置移动到正确的柱面的时延，称为 seek time。如果磁头本身就在正确的柱面上，那么 seek time 就是 0；否则 seek time 就正比于要移动的距离。这一时延最小只有几毫秒，随移动距离的增加，时延会增加到最小时延的 3 - 20 倍。
3. 磁盘转到都正确扇区的时延，称为 rotational latency。典型的磁盘转动一圈需要 10 毫秒，所以平均需要的 rotational latency 就是 5毫秒。
4. 读取数据的时延，称为 transfer time，也就是磁头扫过带读取的数据块所花费的时间。通常的读取速度是 10 MB 每秒。

### 2.2.5 写入数据块

写入数据块的过程与访问数据块的过程基本相同：磁头要放置到正确的柱面上，指向正确的扇区，然后进行数据的移动。整个过程所需要的时延与读取数据的时延也基本相同。

一个稍微复杂的情形是，如果我们想要确认写入是否正确，那么我们就得转动一圈磁盘，再次读取这个扇区。2.5.2 节会讨论一个利用校验和（checksum）来检验写入正确的简单方法。

### 2.2.6 修改数据块

我们并不能直接对磁盘块进行修改，即使只是修改几个字节。为了修改数据，必须：

1. 将块读取到内存中
2. 在内存中对这块数据进行任何想要的更改
3. 将数据写回到原来的块中
4. 如果需要，校验写入过程的正确性

这样一来，所需要的全部时间就是读取数据、在内存中更改数据、写入数据，以及校验数据（如果需要的话）的全部时间之和。