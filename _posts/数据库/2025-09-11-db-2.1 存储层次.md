---
layout: post
title:  "2.1 存储层次"
category: "数据库"
order: "1"
---

计算机系统通常具有不同的用来存储数据的组件。不同组件的数据容量以及访问速度可能相差达到 10^7 量级。不同组件的单位字节的存储开销也不同，但相差得更少，最便宜的与最贵的大概相差 10^3 量级。存储容量最小的设备通常具有最快的访问速度，以及最高的每单位字节存储成本。

### 2.1.1 缓存

最低层次的存储设备是缓存（cache）。缓存通常集成在处理器的芯片上，能够容纳数据或者机器指令。缓存中的数据是主存（也就是更高一层的存储设备）某处的一个拷贝。缓存中的数据值有时会被改变，但对应的主存中的数据的改变是会被延后的。然而在任何时候，缓存中任何数据都对应到主存中的某个位置。缓存和主存中的数据的转移单位通常是较小数量的字节。因此，我们可以认为缓存通常容纳的是机器指令、整数、浮点数或者短的字符串。

通常，机器的缓存也被划分成两级。板上集成缓存（On-board cache）集成在微处理器的芯片上，另一个二级缓存则是在另一个芯片上。

当机器运行指令时，它会从缓存中寻找所要运行的指令，以及指令要用的数据。如果它没用在缓存中找到，它就访问主存，并将指令与数据都拷贝到缓存里。由于缓存只能容纳有限的数据，所以通常需要挤出部分数据来容纳新数据。如果被移除的数据从它被从主存载入以来还没有被修改，那么就无需做更多。但如果被移除的数据从它被从主存载入以来已经被修改，那么最新的值就需要被拷贝到主存中的对应位置。

当缓存中的数据被修改后，一个简单的单处理器机器无需考虑更新对应的主存位置。然而，在多处理器机器中，每个处理器都可以访问同一块主存，并维护私有缓存。这样以来就有必要进行透写（write through），就是说，当缓存数据更新时就立即更新主存。

### 2.1.2 主存

计算机中各种操作的中心就是主存（main memory）。我们可以认为计算机中发生的任何事情（指令的执行、数据的操作）都是在操作主存中的信息。（尽管在实践中，我们通常会把主存数据拷贝到缓存中，如 2.1.1 节的讨论）

主存是随机访问的，也就是所有人可以同时获取任意一个字节。

### 2.1.3 虚拟内存

我们编写程序时，我们使用的数据（程序的变量、读取的文件，等等）都占据虚拟内存地址空间。程序的指令本身也会类似地占据虚拟地址空间。使用 32 位地址空间的机器中，虚拟地址空间大约是4GB。

虚拟地址空间是比通常的主存大得多的，所以当虚拟地址空间被完全时，其中的大部分数据实际上时存储在硬盘中的。我们会在 2.2 节讨论硬盘的操作，但目前为止我们只需要知道，硬盘会被划分为块（blocks）。通常的块大小在 4K 到 56K 字节。虚拟内存在主存和硬盘之间以块为单位移动，一个块对应到主存中通常被称为一个页（page）。机器硬件与操作系统能够将虚拟内存的页加载到主存的任何部分，并将这个块正确地与虚拟地址关联起来。我们并不会在这本书中讨论与此相关的技术。

大多数程序都使用虚拟内存，但这并不是数据库存储数据的方式。然而，近年来对内存数据库系统（main-memory database system）的兴趣越来越强。内存数据库会通过虚拟内存来管理数据，依靠操作系统的分页机制，来将所需的数据加载到主存中。就像大多数应用程序一样，内存数据库在数据量很小，无需被操作系统换出的时候是最有用的。如果一个机器有 32 位地址空间，那么内存数据库就适合用于存储一次性不超过 4GB 的数据（如果实际的主存容量更少，那么这个值就将是主存容量）。这一容量对于许多应用程序来说是足够的，但这不包括大型的 DBMS 应用。

所以，大型数据库系统会直接在硬盘上管理它们的数据。系统容纳的数据规模仅受硬盘的容量限制（或者其他存储设备的容量）。我们接下来会讨论这种模式。

### 2.1.4 二级存储

基本每一个计算机都具有某种二级存储，也就是一种比主存明显更慢，容量明显更大的存储形式，而且也是随机访问的，访问各处所需的事件基本相同（具体差异会在 2.2 节中讨论）。现代计算机使用某种硬盘作为二级存储。通常是磁盘，或者光盘等。光盘更便宜，但是可能不支持写入数据，因此它们只适合存放不会改变的归档数据。

硬盘被认为是虚拟内存和文件系统的底层支持。也就是说，一些硬盘块会被用来应用程序的虚拟内存页，另一些硬盘块会被用来存放文件（或文件的一部分）。文件在硬盘和主存之间也是以块位单位移动的，受操作系统控制，或者受数据库系统控制。从硬盘向主存移动一个块就是一个硬盘读，反之则是一个硬盘写。我们把这两种的任意一种都叫做硬盘 IO 。一部分主存还会被用作文件缓冲区，也就是大文件的若干个块。

例如，当你以读模式打开一个文件时，操作系统可能会在主存中预留一个 4K 的块（假定硬盘块大小为 4K）作为这个文件的缓冲区。当应用程序已经从文件中读取了 4K 个字节，文件的下一个块就会被加载进缓冲区，替换掉旧的内容。这个过程会持续到整个文件读取完毕，或者文件被关闭。

数据库管理系统不依赖操作系统的文件管理器来在主存和二级存储之间移动块，而是自行管理硬盘块。但两者解决的问题基本是相同的。硬盘读写一个块的事件大约是 10-30 毫秒，而这与机器执行一百万条指令所需的时间相当。所以只要是需要读写硬盘的任务，所需的时间都主要由硬盘 IO 决定。因此我们应该尽可能保证，需要读写的磁盘块已经出现在主存中，从而省去硬盘 IO 的开销。我们会在 2.3 和 2.4 节回到这个问题上来，在那里我们会看到一些如何处理在不同层次的存储设备之间移动数据的开销。

### 2.1.5 三级存储

尽管硬盘的容量已经很大，但一些数据库会远远超过一台机器的硬盘的容量总和，甚至是多台计算机的硬盘容量综合。例如，连锁零售店需要存储 TB 级的数据，卫星采集的图像每年会返回 PB 级的数据。

为了满足这样的需求，三级存储（tertiary storage）设备可以用来容纳 TB 级的数据。与二级存储相比，三级存储设备的特点是读写时间与存储容量都显著增加。就访问时间而言，主存访问任何数据的时间基本是一致的，二级存储设备访问不同数据的时间差异不超过一个较小的因子，而三级存储设备访问数据的时间通常会有显著差异，这取决于读写点距离数据有多近。下面大致给出了几种三级存储设备：

1. 按需磁带存储（Ad-hoc Tape Storage）： 最简单的（也是曾经唯一的）三级存储方法就是将数据存储在磁带上。当需要读取三级存储的数据时，就需要操作员定位并用磁带读取器挂载磁带。定位信息的方式就是将磁带缠绕在正确的位置，磁带上的信息就会拷贝到二级存储或者主存设备中。当要写入三级存储设备时，同样需要定位到磁带的正确位置，数据会由硬盘拷贝到磁带。

2. 光盘库（Optical Disk Juke boxes）：“Juke Box”（点唱机）指的是压缩硬盘与只读内存的机架，这是分布式软件通常使用的光盘。光盘上的比特是由微小的黑白区域表示的，用激光照射特定位置，通过反射结果就可以读取数据。机架上的机械臂可以快速地提取一个 CD 硬盘并放到读取器上，从而将其数据加载到二级存储中。向光盘上写入设备也需要专门的 CD 写入器。

3. 磁带库（Tape Silo）：“Silo” 指的是一个房间大小的用来容纳磁带的设备。这些磁带会被机械臂加载到读取器上，所以这就是一种自动化的按需磁带存储，不需要操作员来加载，而是机械臂自动获取并加载

1999 年代的一盘磁带大约能存储 50GB。一个磁带库能存储大约 1TB 数据。CD 的存储容量大约只有 2/3 GB，下一代 CD 则能存储 2.5 GB 左右。一个光盘库大约能存储几 TB 的数据。从三级存储设备获取数据的时间从几秒到几分钟不等。

（当然，这本书写于21世纪初期，现在的存储容量比这个大多了）

### 2.1.6 易失性和非易失性存储

存储设备的另一类特点是它们是易失性的还是非易失性的（volatile, nonvolatile）。易失性存储指的是，设备中存储的数据在断电之后就自动失去了；非易失性存储指的则是，在断电或者故障之后的相当长一段时间内，设备依然能保持其中存储的数据。设备是否是非易失性的问题很重要，因为数据库系统的最重要的能力之一就是能够在电源故障的情况下保持存储的数据。

磁性材料在断电的情况下也能保持磁性，所以磁盘、磁带都是非易失性的。类似地，光学设备例如 CD 也不受断电的影响。但这类设备也通常很难向它们的表面上直接写入数据。总的来说，二级存储基本都是非易失性的。

另一方面，主存基本是易失性的。对于 DRAM 主存来说，它靠电容以及高低电位来表示数据。在断电的情况下，电容的电荷会自然流失，从而其中的数据都会失去。加电的情况下，DRAM 需要不断地读出全部数据然后全部写入它们，从而保持稳定的电位，这一过程是毫秒级的。

运行在易失性主存机器上的数据库系统，如果要更新数据库中的内容，它就必须在磁盘上对更新做一个备份；否则就会有电源故障、信息丢失的风险。所以，查询和修改数据库都会包含大量的硬盘写操作，而其中的大部分都是由于上述原因。一种替代方案是使用一种非易失性的主存储器，称为闪存（flash memory）具有非易失性。另一种替代方案是，通过为常规内存芯片提供电池备用电源，构建所谓的“RAM 磁盘”（RAM disk），从而实现数据的持久化。