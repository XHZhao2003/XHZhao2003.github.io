---
layout: post
title:  "2.7 安全模型"
category: "xv6-book"
order: "14"

---

你可能想知道操作系统是如何应对有缺陷的或者恶意的代码的。严格来说，应对恶意代码是比应对缺陷代码要更困难的，所以这个问题其实是操作系统安全问题。下面是关于操作系统设计的安全问题的，高层次的假设和目标。

操作系统必须假设用户级的进程代码会尽可能地损坏内核或者其他进程。用户代码可能会对指向它内存之外的指针解引用，可能会运行任何 RISC-V 指令，可能会试图直接访问硬件，还可能向系统调用传入一个设计好的参数来让内核故障或者做一些坏的事。内核的目标，就是限制每个进程只能读/写/执行自己的地址空间，使用 32 个通用 RISC-V 寄存器，以系统调用期待的方式影响内核和其他进程。内核必须要阻止其他任何行动。这基本是内核设计的绝对要求。

但是，对于内核自身的代码的期待是非常不同的。通常假定内核代码易于理解，且实现非常谨慎，无缺陷以及恶意代码。这种假设关系到我们如何分析内核代码。例如，内核中的很多内部函数（例如自旋锁）如果没有正确使用就会引起严重错误。当检查这种内核代码时，我们会假定内核代码总体上都是正确的，并遵循内核中定义的函数和数据结构的用法。硬件层面，例如 RISC-V CPU，RAM，磁盘等也都认为是按照文档中记录的行为正常工作的，不会出硬件缺陷。

当然，现实中的事情没有这么简单。你很难阻止一个聪明的用户代码去消耗大量有内核管理的资源，例如磁盘空间，CPU 时间，进程表槽，等等，从而导致系统不可用（或者引起预警）。通常不可能写出来无缺陷的代码，或者设计无缺陷的硬件。如果恶意的作者知道了内核或硬件的缺陷，他就会利用它们。所以，有必要在内核中多设置一些守卫，例如断言，类型检查，栈守护页等等，来预防可能存在的缺陷。最后，用户代码和内核代码的区分有时候也是模糊的。一些具有特权的用户级进程可能提供了关键的服务，也作为操作系统的一部分。一些操作系统中，具有特权的用户代码还可以向内核中插入新代码（例如 Linux 的可加载内核模块）。